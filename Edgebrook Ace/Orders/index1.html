<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Entry App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    .hidden {
      display: none;
    }

    /* App Header */
    .app-header {
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .app-header img {
      height: 40px;
    }

    .app-header .greeting {
      position: absolute;
      left: 50%;
      font-size: 1.25rem;
      transform: translateX(-50%);
      text-align: center;
    }

    #logout-button {
      background: #e60000;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Navigation */
    nav {
      background: #e60000;
      padding: 0.5rem;
      display: flex;
      justify-content: center;
    }

    nav button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1rem;
      margin: 0 1rem;
      cursor: pointer;
    }

    nav button.active {
      font-weight: bold;
      text-decoration: underline;
    }

    .container {
      padding: 1rem;
      max-width: 1500px;
      margin: auto;
      overflow-x: auto
    }

    /* Login Section */
    #login-section {
      background: #fff;
      width: 400px;
      margin: 4rem auto;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      text-align: center;
    }

    #login-section img {
      max-width: 100%;
      height: auto;
      margin-bottom: 0.75rem;
    }

    #login-section h1 {
      margin-bottom: 0.75rem;
      color: #e60000;
    }

    #login-section form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #login-section label {
      width: 80%;
      margin: 0.2rem auto 0.1rem;
      font-weight: bold;
      text-align: left;
      display: block;
    }

    #login-section input {
      width: 80%;
      padding: 0.5rem;
      margin: 0.1rem auto 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #login-section button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
    }

    #login-error {
      margin-top: 1rem;
      color: red;
    }

    /* Form Fields */
    #input-section h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    #input-section form {
      background: #fff;
      padding: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    #input-section label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: bold;
      text-align: left;
    }

    #input-section input,
    #input-section textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #add-customer,
    #input-section button[type="submit"] {
      margin: 1rem 0.5rem 0;
      padding: 0.5rem 1rem;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Customer Group */
    .entry-group {
      border: 1px dashed #ccc;
      background: #fafafa;
      padding: 1rem;
      margin-top: 1rem;
      position: relative;
      border-radius: 4px;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    /* History Table */
    #history-section h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    #history-section {
      margin-top: 1rem;
    }

    #history-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      table-layout: auto;
    }

    #history-table th,
    #history-table td {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid #ddd;
      white-space: nowrap;
    }

    #history-table th {
      background: #e60000;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- Login UI -->
  <div id="login-section">
    <img src="ace-logo.png" alt="ACE Logo" />
    <h1>Delivery Portal</h1>
    <form id="login-form">
      <label for="username">Username</label>
      <input id="username" name="username" required />
      <label for="password">Password</label>
      <input id="password" type="password" name="password" required />
      <button type="submit">Log In</button>
      <p id="login-error"></p>
    </form>
  </div>

  <!-- Main Application (hidden until login) -->
  <div id="app" class="hidden">
    <!-- App Header with logo, greeting, and logout -->
    <header class="app-header">
      <img src="ace-logo.png" alt="ACE Logo" />
      <span class="greeting" id="user-greeting"></span>
      <button id="logout-button">Log Out</button>
    </header>
    <!-- Navigation -->
    <nav>
      <button id="menu-input" class="active">New Delivery</button>
      <button id="menu-history">History</button>
    </nav>

    <div class="container">
      <!-- New Delivery Section -->
      <section id="input-section">
        <h2>New Delivery</h2>
        <form id="deliveryForm">
          <!-- === Customer Information (static) === -->
          <fieldset id="customer-info">
            <legend>Customer Information</legend>
            <label>
              Full Name
              <input type="text" name="customerName" placeholder="Jane Doe" required>
            </label>
            <label>
              Address
              <input type="text" name="customerAddress" placeholder="123 Main St" required>
            </label>
            <label>
              Phone
              <input type="tel" name="customerPhone" placeholder="(555) 123-4567" required>
            </label>
          </fieldset>

          <!-- === Items (dynamic) === -->
          <div id="items-container">
            <div id="item-template" class="entry-group">
              <button type="button" class="remove-btn">×</button>

              <label>
                Item Number
                <input name="itemNumber" placeholder="e.g. 72434" required>
              </label>

              <label>
                Description
                <textarea name="description" placeholder="Top Soil" required></textarea>
              </label>

              <label>
                Date Promised
                <input type="date" name="datePromised" required>
              </label>
            </div>
          </div>
          <button type="button" id="add-item">Add Item</button>

          <!-- === Notes === -->
          <label for="notes">
            Notes
            <textarea name="notes" id="notes" placeholder="Any special instructions…"></textarea>
          </label>

          <button type="submit">Save Delivery</button>
        </form>
      </section>

      <!-- History Section -->
      <section id="history-section" class="hidden">
        <h2>Delivery History</h2>
        <table id="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Saved By</th>
              <th>Item Number</th>
              <th>Description</th>
              <th>Promised</th>
              <th>Customer</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyDNPziZqj3zHL_y01fXXH5uBYQB0ctS6T0',
      authDomain: 'ace-orders-9de41.firebaseapp.com',
      projectId: 'ace-orders-9de41',
      storageBucket: 'ace-orders-9de41.firebasestorage.app',
      messagingSenderId: '931385542602',
      appId: '1:931385542602:web:9858f492ad65e36ebb7133'
    };
    const appInit = initializeApp(firebaseConfig);
    const db = getFirestore(appInit);
    const userCredentials = {
      '1': { password: '1111', name: 'George Demertzis' },
      '20': { password: '2020', name: 'Matt Teister' },
      '21': { password: '2121', name: 'Leo Fernandez' },
      '22': { password: '2222', name: 'Aidan Greiner' },
      '30': { password: '3030', name: 'Jeff Jozwik' },
      '31': { password: '3131', name: 'Pat Debellis' },
      '32': { password: '3232', name: 'Gabriel Meadows' },
      '33': { password: '3333', name: 'Leyton Meadows' },
      '34': { password: '3434', name: 'Ian Davern' },
      '35': { password: '3535', name: 'Annie Eck' },
      '36': { password: '3636', name: 'Alek Giebelhausen' },
      '37': { password: '3737', name: 'Reagan Finneke' },
      '38': { password: '3838', name: 'Joey Ward' }
    };
    let loggedUser = null;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Ready - Setting up handlers'); // TODO: Take out
      // Login
      const loginForm = document.getElementById('login-form');
      loginForm.addEventListener('submit', e => {
        e.preventDefault();
        const { username, password } = Object.fromEntries(new FormData(loginForm));
        const creds = userCredentials[username];
        if (creds && creds.password === password) {
          loggedUser = username;
          loginForm.reset();
          document.getElementById('user-greeting').textContent = `Welcome, ${creds.name}!`;
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('app').classList.remove('hidden');
        } else {
          document.getElementById('login-error').textContent = 'Invalid credentials';
        }
      });

      // Logout
      document.getElementById('logout-button').addEventListener('click', () => {
        loggedUser = null;
        document.getElementById('app').classList.add('hidden');
        document.getElementById('login-error').textContent = '';
        document.getElementById('login-section').classList.remove('hidden');
      });

      // Navigation
      function showSection(name) {
        document.getElementById('input-section').style.display = name === 'input' ? 'block' : 'none';
        document.getElementById('history-section').style.display = name === 'history' ? 'block' : 'none';
        document.getElementById('menu-input').classList.toggle('active', name === 'input');
        document.getElementById('menu-history').classList.toggle('active', name === 'history');
      }
      document.getElementById('menu-input').onclick = () => showSection('input');
      document.getElementById('menu-history').onclick = () => { showSection('history'); loadHistory(); };

      const phoneInput = document.querySelector('[name="customerPhone"]');
      phone.addEventListener('input', e => {
        let d = e.target.value.replace(/\D/g, '').substring(0, 10);
        let r = '';
        if (d.length > 0) r += '(' + d.substr(0, 3);
        if (d.length >= 4) r += ') ' + d.substr(3, 3);
        if (d.length >= 7) r += '-' + d.substr(6, 4);
        e.target.value = r;
      });

      function attachGroupEvents(group) {
        group.querySelector('.remove-btn').addEventListener('click', () => {
          const groups = document.querySelectorAll('#items-container .entry-group');
          if (groups.length > 1) group.remove();
        });
      }

      // Item groups
      document.getElementById('add-item').addEventListener('click', () => {
        const tpl = document.getElementById('item-template');
        const clone = tpl.cloneNode(true);
        clone.removeAttribute('id');
        document.getElementById('items-container').appendChild(clone);
        attachGroupEvents(clone);
      });

      // initialize on the template
      attachGroupEvents(document.getElementById('item-template'));

      // Build and open printable form
      function openDeliveryForm(record) {
        // 1) Open a new blank window
        const formWin = window.open('', '_blank', 'width=600,height=800');

        // 2) Build and write the complete HTML for the delivery form
        formWin.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>Customer Delivery Information</title>
        <style>
          /* Basic page styling */
          body {
            font-family: Arial;
            padding: 1rem;
          }
          /* Center header and logo */
          header {
            text-align: center;
          }
          header img {
            max-height: 80px;
            margin: 0 auto;
          }
          /* Table styling */
          table {
            width: 100%;
            border-collapse: collapse;
          }
          th, td {
            border: 1px solid #333;
            padding: 0.5rem;
            text-align: left;
          }
        </style>
      </head>
      <body>
        <!-- Header with logo and title -->
        <header>
          <img src="ace-logo.png" alt="Company Logo">
          <h1>Customer Delivery Information</h1>
        </header>

        <!-- Summary Info -->
        <p><strong>Date:</strong> ${record.date.toDate().toLocaleString()}</p>
        <p><strong>Prepared By:</strong> ${record.user}</p>

        <!-- Customer Details -->
        <p><strong>Customer:</strong> ${record.customer.name}</p>
        <p><strong>Address:</strong> ${record.customer.address}</p>
        <p><strong>Phone:</strong> ${record.customer.phone}</p>

        <!-- Items Table -->
        <table>
          <thead>
            <tr>
              <th>Item #</th>
              <th>Description</th>
              <th>Promised</th>
            </tr>
          </thead>
          <tbody>
            ${record.items.map(it => `
              <tr>
                <td>${it.itemNumber}</td>
                <td>${it.description}</td>
                <td>${it.promised.toDate().toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <!-- Notes Section -->
        <p><strong>Notes:</strong> ${record.notes || ''}</p>

        <!-- Print Button -->
        <p style="text-align:center; margin-top:2rem;">
          <button onclick="window.print()">Print</button>
        </p>
      </body>
    </html>
  `); 

        // 3) Close the document so it renders
        formWin.document.close();
      }


      // Submission
      document.getElementById('deliveryForm').addEventListener('submit', async e => {
        e.preventDefault();
        // open popup early (to avoid blockers)
        const win = window.open('', '_blank');
        if (!win) return alert('Enable pop-ups to preview the form.');

        // 1) Customer (static)
        const customer = {
          name: e.target.customerName.value,
          address: e.target.customerAddress.value,
          phone: e.target.customerPhone.value
        };

        // 2) Items (dynamic)
        const items = Array.from(e.target.querySelectorAll('#items-container .entry-group'))
          .map(g => {
            const dateStr = g.querySelector('[name="datePromised"]').value;
            return {
              itemNumber: g.querySelector('[name="itemNumber"]').value,
              description: g.querySelector('[name="description"]').value,
              promised: Timestamp.fromDate(new Date(dateStr))
            };
          });

        // 3) Notes
        const notes = e.target.notes.value;

        // 4) Build record
        const record = {
          date: Timestamp.fromDate(new Date()),
          user: userCredentials[loggedUser].name,
          customer, items, notes
        };

        // 5) Save & preview
        try {
          await addDoc(collection(db, 'deliveries'), record);
          openDeliveryForm(record);
          e.target.reset();
        } catch (err) {
          win.close();
          console.error(err);
          alert('Error saving delivery!');
        }
      });

      // History load
      async function loadHistory() {
        const cutoff = Timestamp.fromDate(new Date(new Date().setDate(new Date().getDate() - 20)));
        const q = query(collection(db, 'deliveries'), where('date', '>=', cutoff), orderBy('date', 'desc'));
        const snap = await getDocs(q);
        const tbody = document.querySelector('#history-table tbody'); tbody.innerHTML = '';
        tbody.innerHTML = '';

        snap.forEach(doc => {
          const r = doc.data();
          r.customers.forEach(c => {
            const tr = document.createElement('tr');
            const values = [
              r.date.toDate().toLocaleDateString('en-US'),
              r.user,
              r.item,
              r.desc || r.description,
              r.promised.toDate().toLocaleDateString('en-US'),
              c.fullName,
              c.phone,
              c.address,
              c.notes
            ];
            values.forEach((val, idx) => {
              const td = document.createElement('td');
              // For the address column (index 7), create an actual link
              if (idx === 7) {
                const a = document.createElement('a');
                a.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(val)}`;
                a.target = '_blank';
                a.textContent = val;
                td.appendChild(a);
              } else {
                td.textContent = val;
              }
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        });
      }
    });
  </script>
</body>

</html>