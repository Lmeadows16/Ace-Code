<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Entry App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    .hidden {
      display: none;
    }

    /* App Header */
    .app-header {
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .app-header img {
      height: 40px;
    }

    .app-header .greeting {
      position: absolute;
      left: 50%;
      font-size: 1.25rem;
      transform: translateX(-50%);
      text-align: center;
    }

    #logout-button {
      background: #e60000;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Navigation */
    nav {
      background: #e60000;
      padding: 0.5rem;
      display: flex;
      justify-content: center;
    }

    nav button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1rem;
      margin: 0 1rem;
      cursor: pointer;
    }

    nav button.active {
      font-weight: bold;
      text-decoration: underline;
    }

    .container {
      padding: 1rem;
      max-width: 1500px;
      margin: auto;
      overflow-x: auto
    }

    #edit-section table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    #edit-section th,
    #edit-section td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

    #edit-section th {
      background: #e60000;
      color: #fff;
    }

    /* Shared button styling */
    .toolbar-btn {
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
    }

    /* Top toolbar: Remove & + Add, left‑aligned and shrink‑wrapped */
    #top-toolbar {
      display: inline-flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* Bottom toolbar: Change Password, full‑width but right‑aligned */
    #bottom-toolbar {
      display: flex;
      justify-content: flex-end;
      margin-top: 1rem;
    }

    /* Ensure the button itself doesn’t stretch */
    #bottom-toolbar .toolbar-btn {
      display: inline-block;
    }




    /* Login Section */
    #login-section {
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: #fff;
      width: 400px;
      margin: 4rem auto;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .login-container {
      display: flex;
      flex-direction: column;
    }

    .hidden {
      display: none;
    }

    #login-section img {
      max-width: 400px;
      width: auto;
      height: auto;
      margin-bottom: 1rem;
    }

    #login-section h1 {
      font-size: 2rem;
      color: #e60000;
      margin: 0.5rem 0;
    }

    #login-section h2 {
      font-size: 1.5rem;
      margin: 1rem 0;
    }

    #login-form,
    #register-form {
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #login-section form.hidden {
      display: none !important;
    }

    #login-section label {
      display: block;
      margin: 0.2rem auto 0.1rem;
      width: 90%;
      text-align: left;
      font-weight: bold;
    }

    #login-section input {
      display: block;
      margin: 0.1rem auto 0.5rem;
      width: 90%;
      padding: 0.5rem;
    }

    #login-section button[type="submit"] {
      margin: 1rem auto 0;
      padding: 0.75 1.5rem;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      width: 100%;
      max-width: 200px;
    }

    .link-button {
      background: none;
      border: none;
      color: #e60000;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 1rem;
    }

    #login-error,
    #register-error,
    #register-success {
      margin-top: 1rem;
      color: red;
    }

    /* Form Fields */
    #input-section h2 {
      margin: 0.5rem auto;
      text-align: center;
    }

    #input-section form {
      background: #fff;
      padding: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    #input-section label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: bold;
      text-align: left;
    }

    #input-section input,
    #input-section textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #add-customer,
    #input-section button[type="submit"] {
      margin: 1rem 0.5rem 0;
      padding: 0.5rem 1rem;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Customer Group */
    .entry-group {
      border: 1px dashed #ccc;
      background: #fafafa;
      padding: 1rem;
      margin-top: 1rem;
      position: relative;
      border-radius: 4px;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    /* History Table */
    #history-section h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    #history-section {
      margin-top: 1rem;
    }

    #history-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      table-layout: auto;
    }

    #history-table th,
    #history-table td {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid #ddd;
      white-space: nowrap;
    }

    #history-table th {
      background: #e60000;
      color: #fff;
    }

    /* Special Orders styling — mirror #input-section */
    #special-section h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    #special-section form {
      background: #fff;
      padding: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    #special-section label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: bold;
      text-align: left;
    }

    #special-section input,
    #special-section textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #special-section button[type="submit"] {
      margin: 1rem 0.5rem 0;
      padding: 0.5rem 1rem;
      background: #e60000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Login UI -->
  <div id="login-section" class="container login-container">
    <img src="ace-logo.png" alt="ACE Logo">
    <h1>Delivery Entry App</h1>
    <h2 id="login-title">Sign In</h2>
    <form id="login-form">
      <label>Username<input name="username" required></label><br>
      <label>Password<input type="password" name="password" required></label><br>
      <button type="submit">Log In</button>
      <p id="login-error" style="color:red"></p>
    </form>
  </div>

  <!-- Main Application (hidden until login) -->
  <div id="app" class="hidden">
    <!-- App Header with logo, greeting, and logout -->
    <header class="app-header">
      <img src="ace-logo.png" alt="ACE Logo" />
      <span class="greeting" id="user-greeting"></span>
      <button id="logout-button">Log Out</button>
    </header>
    <!-- Navigation -->
    <nav>
      <button id="menu-input" class="active">New Delivery</button>
      <button id="menu-history">History</button>
      <button id="menu-special">Special Orders</button>
      <button id="menu-edit" class="hidden">Edit Users</button>
    </nav>

    <div class="container">
      <!-- New Delivery Section -->
      <section id="input-section">
        <h2>New Delivery</h2>
        <form id="deliveryForm">
          <label for="dl-itemNumber">Item Number</label>
          <input id="dl-itemNumber" name="itemNumber" placeholder="e.g. 72434" required />

          <label for="dl-description">Description</label>
          <textarea id="dl-description" name="description" placeholder="e.g. Top Soil" required></textarea>

          <label for="dl-datePromised">Date Promised</label>
          <input id="dl-datePromised" type="date" name="datePromised" required />

          <label for="dl-fullName">Full Name</label>
          <input id="dl-fullName" name="fullName" placeholder="e.g. Jane Doe" required />

          <label for="dl-phone">Phone</label>
          <input id="dl-phone" name="phone" placeholder="(555) 123-4567" />

          <label for="dl-address">Address</label>
          <textarea id="dl-address" name="address" placeholder="e.g. 123 Main St, City, ST"></textarea>

          <label for="dl-notes">Notes</label>
          <textarea id="dl-notes" name="notes"></textarea>

          <button type="submit">Save Delivery</button>
        </form>
      </section>

      <!-- History Section -->
      <section id="history-section" class="hidden">
        <h2>Delivery History</h2>
        <table id="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Saved By</th>
              <th>Item Number</th>
              <th>Description</th>
              <th>Promised</th>
              <th>Customer</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
      <!--Special Orders Section (Initially hidden)-->
      <section id="special-section" class="hidden">
        <h2>Special Orders</h2>
        <form id="specialForm">
          <label for="sp-itemNumber">Item Number</label>
          <input id="sp-itemNumber" name="itemNumber" placeholder="e.g. 72434" required>

          <label for="sp-description">Description</label>
          <textarea id="sp-description" name="description" placeholder="e.g. Top Soil" required></textarea>

          <label for="sp-quantity">Quantity</label>
          <input type="number" id="sp-quantity" name="quantity" min="1" placeholder="1" required>

          <label for="sp-fullname">Full Name</label>
          <input id="sp-fullname" name="fullName" placeholder="e.g. Jane Doe" required>

          <label for="sp-phone">Phone</label>
          <input id="sp-phone" name="phone" placeholder="(555) 123-4567" required>

          <button type="submit">Submit Order</button>
        </form>
      </section>
      <section id="edit-section" class="hidden">
        <h2>Edit Users</h2>
        <!-- Top toolbar: Remove & + Add -->
        <div id="top-toolbar">
          <button id="remove-users" class="toolbar-btn">Remove</button>
          <button id="add-user" class="toolbar-btn">+ Add</button>
        </div>
        <table id="users-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" /></th>
              <th>Name</th>
              <th>Username</th>
              <th>Password</th>
              <th>Admin</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- Bottom toolbar: Change Password -->
        <div id="bottom-toolbar">
          <button id="change-password" class="toolbar-btn">Change Password</button>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
    import { firebaseConfig } from './configure.js';

    // const firebaseConfig = {
    //   apiKey: 'AIzaSyDNPziZqj3zHL_y01fXXH5uBYQB0ctS6T0',
    //   authDomain: 'ace-orders-9de41.firebaseapp.com',
    //   projectId: 'ace-orders-9de41',
    //   storageBucket: 'ace-orders-9de41.firebasestorage.app',
    //   messagingSenderId: '931385542602',
    //   appId: '1:931385542602:web:9858f492ad65e36ebb7133'
    // };

    const appInit = initializeApp(firebaseConfig);
    const db = getFirestore(appInit);

    let isAdmin = false;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Ready - Setting up handlers'); // TODO: Take out
      // Constants
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');
      loginForm.addEventListener('submit', async e => {
        e.preventDefault();                // ← actually _call_ preventDefault
        loginError.textContent = '';       // ← clear any prior error

        const data = Object.fromEntries(new FormData(loginForm));
        console.log('Attempting login:', data);

        try {
          const resp = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const body = await resp.json();  // ← only call .json() once

          if (!resp.ok) {
            // body.error should come from your server
            throw new Error(body.error || 'Login failed');
          }

          // at this point body === { name: '...', admin: true/false }
          const { name, is_admin } = body;
          isAdmin = is_admin;

          // hide login, show main app
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('app').classList.remove('hidden');
          document.getElementById('user-greeting').textContent = `Welcome, ${name}!`;

          initApp();
        } catch (err) {
          console.error(err);
          loginError.textContent = err.message;
        }
      });
    });

    function initApp() {
      // Show edit users tab for admins
      if (isAdmin) document.getElementById('menu-edit').classList.remove('hidden');

      // Section toggling
      const sections = ['input', 'history', 'special', 'edit'];
      function showSection(name) {
        sections.forEach(sec => {
          document.getElementById(`${sec}-section`).classList.toggle('hidden', sec !== name);
          document.getElementById(`menu-${sec}`).classList.toggle('active', sec === name);
        });
      }

      document.getElementById('menu-input').onclick = () => showSection('input');
      document.getElementById('menu-history').onclick = () => { showSection('history'); loadHistory(); };
      document.getElementById('menu-special').onclick = () => showSection('special');
      document.getElementById('menu-edit').onclick = () => { showSection('edit'); loadUsers(); };

      // Order Submission
      document.getElementById('specialForm').addEventListener('submit', e => {
        e.preventDefault();
        const win = window.open('', '_blank');
        if (!win) { alert("Enable pop-ups"); return; }
        const data = Object.fromEntries(new FormData(e.target));
        const html = `
          <h1>Special Order</h1>
          <u1>
            <li><strong>Item #:</strong> ${data.itemNumber}</li>
            <li><strong>Description:</strong> ${data.description}</li>
            <li><strong>Quantity:</strong> ${data.quantity}</li>
            <li><strong>Full Name:</strong> ${data.fullName}</li>
            <li><strong>Phone:</strong> ${data.phone}</li>
          </ul>
        `;
        win.document.write(html);
        win.document.close();
        e.target.reset();

      })

      // Delivery Submission
      document.getElementById('deliveryForm').addEventListener('submit', async e => {
        e.preventDefault();

        // 1) Open the popup synchronously
        const win = window.open('', '_blank');
        if (!win) {
          alert("Please enable pop‑ups for this site to preview the delivery.");
          return;
        }

        // 2) Gather form data directly from flat fields
        const data = Object.fromEntries(new FormData(e.target));
        // Convert promised date to a Firestore Timestamp:
        const [y, m, d] = data.datePromised.split('-').map(Number);
        const promisedTs = Timestamp.fromDate(new Date(y, m - 1, d));

        // Build the record
        const record = {
          date: Timestamp.fromDate(new Date()),
          item: data.itemNumber,
          description: data.description,
          promised: promisedTs,
          fullName: data.fullName,
          phone: data.phone,
          address: data.address,
          notes: data.notes,
          user: document.getElementById('user-greeting').textContent.replace('Welcome, ', '')
        };

        try {
          // 3) Write to Firestore
          const docRef = await addDoc(collection(db, 'deliveries'), record);
          console.log('Wrote delivery with ID', docRef.id);

          // 4) Populate the popup with a simple preview
          win.document.write(`
      <h1>Delivery Saved</h1>
      <ul>
        <li><strong>Item #:</strong> ${record.item}</li>
        <li><strong>Description:</strong> ${record.description}</li>
        <li><strong>Date Promised:</strong> ${data.datePromised}</li>
        <li><strong>Full Name:</strong> ${record.fullName}</li>
        <li><strong>Phone:</strong> ${record.phone}</li>
        <li><strong>Address:</strong> ${record.address}</li>
        <li><strong>Notes:</strong> ${record.notes}</li>
        <li><strong>Saved By:</strong> ${record.user}</li>
        <li><strong>Saved At:</strong> ${new Date().toLocaleString()}</li>
      </ul>
    `);
          win.document.close();

          // 5) Reset the form
          e.target.reset();
          alert('Delivery saved successfully!');
        } catch (err) {
          // On error, close the preview window and inform the user
          win.close();
          console.error(err);
          alert('Error saving delivery. Please try again.');
          return;
        }
      });

      // History load
      async function loadHistory() {
        const q = query(
          collection(db, 'deliveries'),
          orderBy('date', 'desc')
        );
        const snap = await getDocs(q);

        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';  // clear old rows

        snap.forEach(doc => {
          const r = doc.data();
          const tr = document.createElement('tr');

          // Flat list of values in the same order as your <thead>
          const values = [
            r.date.toDate().toLocaleDateString('en-US'),  // Date
            r.user || '—',                                // Saved By
            r.item,                                       // Item Number
            r.description,                                // Description
            r.promised.toDate().toLocaleDateString(),     // Promised
            r.fullName,                                   // Customer
            r.phone,                                      // Phone
            r.address,                                    // Address ← clickable
            r.notes                                       // Notes
          ];

          values.forEach((val, idx) => {
            const td = document.createElement('td');

            if (idx === 7 && val) {
              // Address column: render as link
              const a = document.createElement('a');
              a.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(val)}`;
              a.target = '_blank';
              a.textContent = val;
              td.appendChild(a);
            } else {
              td.textContent = val || '';
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      }

      // Logout
      document.getElementById('logout-button').onclick = () => location.reload();

      // Add user
      document.getElementById('add-user').onclick = async () => {
        const name = prompt('Full Name:'); if (!name) return;
        const username = prompt('Username:'); if (!username) return;
        const password = prompt('Password:'); if (!password) return;
        const isAdmin = confirm('Grant ADMIN privileges to this user? OK = Yes, Cancel = No');

        const resp = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, username, password, admin: isAdmin })
        });
        if (!resp.ok) {
          const err = await resp.json();
          return alert('Error adding user: ' + err.error);
        }
        loadUsers();
      };

      // Remove users
      document.getElementById('remove-users').onclick = async () => {
        const checked = Array.from(document.querySelectorAll('#users-table tbody input:checked')).map(cb => cb.value);
        if (!checked.length) return alert('Select users to remove');
        if (!confirm(`Remove ${checked.length} user(s)?`)) return;
        await fetch('/api/users', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: checked }) });
        loadUsers();
      };

      // Change password for selected users
      document.getElementById('change-password').onclick = async () => {
        // collect usernames of checked rows
        const checked = Array.from(
          document.querySelectorAll('#users-table tbody input:checked')
        ).map(cb => cb.value);

        if (!checked.length) {
          return alert('Select at least one user to change password.');
        }

        // for each user, prompt & update
        for (const username of checked) {
          const newPass = prompt(`Enter new password for ${username}:`);
          if (!newPass) {
            // skip if cancelled or empty
            continue;
          }

          const resp = await fetch(`/api/users/${encodeURIComponent(username)}/password`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: newPass })
          });

          if (!resp.ok) {
            const err = await resp.json();
            alert(`Error changing password for ${username}: ${err.error || resp.statusText}`);
          } else {
            console.log(`Password updated for ${username}`);
          }
        }

        // finally, reload the table
        loadUsers();
      };



      // Select all toggle
      document.getElementById('select-all').onchange = e => {
        document.querySelectorAll('#users-table tbody input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
      };

      // Load users
      async function loadUsers() {
        const resp = await fetch('/api/users');
        const users = await resp.json();
        const tbody = document.querySelector('#users-table tbody'); tbody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" value="${u.username}" /></td>
            <td>${u.name}</td>
            <td>${u.username}</td>
            <td>${u.password}</td>
            <td>${u.admin ? 'Yes' : 'No'}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }
  </script>
</body>

</html>